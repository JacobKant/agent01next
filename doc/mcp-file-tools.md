# MCP File Tools - Инструменты для работы с файлами

## Описание

Добавлен новый MCP сервер `file-server.ts`, который предоставляет AI-агенту безопасные инструменты для работы с файловой системой. Все операции ограничены директорией `data/files/` для безопасности.

## Безопасность

- ✅ Все операции ограничены директорией `data/files/`
- ✅ Проверка путей предотвращает выход за пределы разрешенной директории
- ✅ Автоматическое создание поддиректорий при сохранении файлов
- ✅ Защита от path traversal атак (блокировка `../`)

## Доступные инструменты

### 1. save_file

Сохраняет текст в файл в разрешенной директории.

**Параметры:**
- `filePath` (string, обязательный) - Путь к файлу относительно `data/files/` (например, `documents/note.txt`)
- `content` (string, обязательный) - Содержимое файла для сохранения
- `encoding` (enum, опциональный) - Кодировка файла: `utf8` или `utf-8` (по умолчанию `utf8`)

**Возможности:**
- Автоматически создает директории если их нет
- Безопасная проверка пути
- Возвращает информацию о сохраненном файле (размер, путь)

**Пример использования:**
```json
{
  "filePath": "documents/meeting-notes.txt",
  "content": "Заметки с встречи:\n- Пункт 1\n- Пункт 2",
  "encoding": "utf8"
}
```

**Пример ответа:**
```json
{
  "success": true,
  "filePath": "documents/meeting-notes.txt",
  "fullPath": "data/files/documents/meeting-notes.txt",
  "size": 45,
  "message": "Файл успешно сохранен"
}
```

**Ошибки:**
- Если путь выходит за пределы `data/files/`, возвращается ошибка
- Если не удается создать директорию или записать файл, возвращается ошибка

### 2. read_file

Читает содержимое файла из разрешенной директории.

**Параметры:**
- `filePath` (string, обязательный) - Путь к файлу относительно `data/files/`
- `encoding` (enum, опциональный) - Кодировка файла: `utf8` или `utf-8` (по умолчанию `utf8`)

**Возможности:**
- Безопасная проверка пути
- Возвращает содержимое, размер и дату изменения файла

**Пример использования:**
```json
{
  "filePath": "documents/meeting-notes.txt",
  "encoding": "utf8"
}
```

**Пример ответа:**
```json
{
  "success": true,
  "filePath": "documents/meeting-notes.txt",
  "fullPath": "data/files/documents/meeting-notes.txt",
  "content": "Заметки с встречи:\n- Пункт 1\n- Пункт 2",
  "size": 45,
  "encoding": "utf8",
  "modified": "2024-12-19T10:30:00.000Z"
}
```

**Ошибки:**
- Если файл не найден, возвращается ошибка
- Если путь выходит за пределы разрешенной директории, возвращается ошибка

### 3. file_exists

Проверяет существование файла или директории.

**Параметры:**
- `filePath` (string, обязательный) - Путь к файлу относительно `data/files/`

**Возможности:**
- Безопасная проверка пути
- Возвращает информацию о файле/директории (размер, тип, дата изменения)

**Пример использования:**
```json
{
  "filePath": "documents/meeting-notes.txt"
}
```

**Пример ответа (файл существует):**
```json
{
  "exists": true,
  "filePath": "documents/meeting-notes.txt",
  "fullPath": "data/files/documents/meeting-notes.txt",
  "size": 45,
  "isFile": true,
  "isDirectory": false,
  "modified": "2024-12-19T10:30:00.000Z"
}
```

**Пример ответа (файл не существует):**
```json
{
  "exists": false,
  "filePath": "documents/meeting-notes.txt",
  "fullPath": "data/files/documents/meeting-notes.txt"
}
```

## Архитектура

### Разрешенная директория

Все файловые операции ограничены директорией:
```
data/files/
```

Эта директория создается автоматически при первом запуске MCP сервера.

### Проверка безопасности путей

Функция `isPathAllowed()` проверяет что:
1. Путь разрешен (не содержит `../` в начале)
2. Путь не является абсолютным
3. Путь находится внутри `data/files/`

**Примеры разрешенных путей:**
- ✅ `documents/note.txt`
- ✅ `reports/2024/december.md`
- ✅ `data.json`

**Примеры запрещенных путей:**
- ❌ `../config.json` (выход за пределы)
- ❌ `/etc/passwd` (абсолютный путь)
- ❌ `../../secret.txt` (path traversal)

## Использование

AI-агент теперь может:
1. Сохранять текстовые данные в файлы
2. Читать сохраненные файлы
3. Проверять существование файлов
4. Организовывать файлы в поддиректориях

**Примеры вопросов:**
- "Сохрани эту информацию в файл `notes/important.txt`"
- "Прочитай файл `documents/report.md`"
- "Проверь существует ли файл `data/config.json`"
- "Сохрани результаты анализа в `reports/analysis-2024.txt`"

## Технические детали

### Автоматическое создание директорий

При сохранении файла в несуществующую директорию, она создается автоматически:
```typescript
await mkdir(dir, { recursive: true });
```

### Кодировка

Поддерживается только UTF-8 кодировка для текстовых файлов. Бинарные файлы не поддерживаются.

### Ограничения

- Максимальный размер файла ограничен доступной памятью Node.js
- Поддерживаются только текстовые файлы (UTF-8)
- Нет поддержки удаления файлов (только чтение и запись)
- Нет поддержки списка файлов в директории

## Интеграция

MCP сервер автоматически подключается через `McpClientManager`:
- Сервер запускается при первом вызове `executeChatWithMCP`
- Все три инструмента (`save_file`, `read_file`, `file_exists`) доступны AI-агенту
- Инструменты работают вместе с другими MCP серверами (курсы валют, веб-поиск)

## Примеры сценариев

### Сценарий 1: Сохранение заметок
```
Пользователь: "Сохрани эту информацию: курс доллара 95 рублей"
AI: [Использует cbr_rates] -> [Использует save_file] -> "Информация сохранена в файл"
```

### Сценарий 2: Чтение и анализ
```
Пользователь: "Прочитай файл notes.txt и найди информацию о курсе валют"
AI: [Использует read_file] -> [Использует search_web] -> [Анализирует результаты]
```

### Сценарий 3: Проверка и сохранение
```
Пользователь: "Проверь существует ли файл report.md, если нет - создай его с заголовком"
AI: [Использует file_exists] -> [Если нет, использует save_file]
```

