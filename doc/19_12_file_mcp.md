# 19.12.2024 - Добавлен MCP сервер для работы с файлами

## Выполненные задачи

### 1. Создан новый MCP сервер `file-server.ts`

**Файл:** `src/mcp/file-server.ts`

Предоставляет три инструмента для безопасной работы с файлами:

#### `save_file`
- Сохраняет текст в файл
- Автоматически создает директории
- Безопасная проверка путей (только в `data/files/`)
- Параметры:
  - `filePath` - путь относительно `data/files/`
  - `content` - содержимое файла
  - `encoding` - кодировка (utf8)

#### `read_file`
- Читает содержимое файла
- Возвращает метаданные (размер, дата изменения)
- Безопасная проверка путей
- Параметры:
  - `filePath` - путь относительно `data/files/`
  - `encoding` - кодировка (utf8)

#### `file_exists`
- Проверяет существование файла/директории
- Возвращает информацию о файле
- Параметры:
  - `filePath` - путь относительно `data/files/`

### 2. Обновлен `McpClientManager`

**Файл:** `src/lib/mcp-client.ts`

Добавлен новый сервер в список:
```typescript
{
  name: "file-server",
  serverPath: join(process.cwd(), "src", "mcp", "file-server.ts"),
}
```

### 3. Создана директория для файлов

**Директория:** `data/files/`

- Создается автоматически при первом запуске сервера
- Все файловые операции ограничены этой директорией
- Поддиректории создаются автоматически

### 4. Реализована безопасность

**Механизмы защиты:**
- ✅ Проверка путей через `isPathAllowed()`
- ✅ Блокировка path traversal (`../`)
- ✅ Блокировка абсолютных путей
- ✅ Ограничение только директорией `data/files/`

**Функция проверки:**
```typescript
function isPathAllowed(filePath: string): boolean {
  const resolvedPath = resolve(ALLOWED_DIRECTORY, filePath);
  const relativePath = relative(ALLOWED_DIRECTORY, resolvedPath);
  return !relativePath.startsWith("..") && !relativePath.startsWith("/");
}
```

## Примеры использования

### Сохранение файла
```
Пользователь: "Сохрани эту информацию в файл notes/important.txt"
AI: [Использует save_file] -> "Файл успешно сохранен"
```

### Чтение файла
```
Пользователь: "Прочитай файл documents/report.md"
AI: [Использует read_file] -> [Возвращает содержимое]
```

### Проверка существования
```
Пользователь: "Проверь существует ли файл config.json"
AI: [Использует file_exists] -> [Возвращает результат]
```

### Комбинирование с другими инструментами
```
Пользователь: "Найди информацию о курсе доллара и сохрани в файл rates/usd.txt"
AI: [Использует search_web] -> [Использует save_file] -> "Информация сохранена"
```

## Технические детали

### Структура файлов
```
data/
  ├── files/          # Разрешенная директория для файлов
  │   ├── documents/  # Пример поддиректории
  │   ├── notes/      # Пример поддиректории
  │   └── reports/    # Пример поддиректории
  └── chats.db        # База данных чатов
```

### Обработка ошибок
- Все ошибки логируются в консоль
- Ошибки возвращаются в JSON формате
- Понятные сообщения об ошибках для AI-агента

### Производительность
- Асинхронные операции (fs/promises)
- Автоматическое создание директорий
- Эффективная проверка путей

## Ограничения

- Только текстовые файлы (UTF-8)
- Максимальный размер ограничен памятью Node.js
- Нет поддержки удаления файлов
- Нет поддержки списка файлов в директории
- Нет поддержки бинарных файлов

## Следующие шаги

Возможные улучшения:
1. Добавить инструмент `list_files` для просмотра содержимого директории
2. Добавить инструмент `delete_file` для удаления файлов
3. Добавить поддержку бинарных файлов (base64)
4. Добавить поддержку JSON файлов (автоматический парсинг)
5. Добавить инструмент `append_file` для добавления в конец файла
6. Добавить ограничение максимального размера файла

## Проверка

✅ Проект успешно собирается (`npm run build`)
✅ Нет ошибок линтера
✅ Все TypeScript типы корректны
✅ Директория `data/files/` создана
✅ Безопасность путей реализована

