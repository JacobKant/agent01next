# 19.12.2024 - Добавлен MCP сервер для работы с интернетом

## Выполненные задачи

### 1. Создан новый MCP сервер `web-server.ts`

**Файл:** `src/mcp/web-server.ts`

Предоставляет два инструмента для работы с веб-ресурсами:

#### `fetch_webpage`
- Получает содержимое веб-страницы
- Извлекает только текст (удаляет HTML теги)
- Автоматически сжимает большие страницы
- Декодирует HTML entities
- Параметры:
  - `url` - адрес страницы
  - `maxLength` - максимальная длина текста (по умолчанию 5000)

#### `search_web`
- Выполняет поиск через DuckDuckGo API
- Возвращает основной ответ и связанные темы
- Параметры:
  - `query` - поисковый запрос
  - `maxResults` - количество результатов (по умолчанию 5)

### 2. Модифицирован `McpClientManager`

**Файл:** `src/lib/mcp-client.ts`

Обновления:
- Добавлена поддержка множественных MCP серверов
- Автоматическое подключение к серверам из списка конфигурации
- Маршрутизация вызовов tools к соответствующим серверам
- Корректное закрытие всех подключений

**Список подключаемых серверов:**
1. `cbr-rates-server` - курсы валют ЦБ РФ
2. `web-fetch-server` - работа с интернетом

### 3. Интеграция с `executeChatWithMCP`

**Файл:** `src/lib/chat-executor.ts`

Функция автоматически:
- Получает все tools из всех подключенных серверов
- Передает их в LLM
- Обрабатывает tool calls
- Поддерживает цепочку вызовов

### 4. Исправлены TypeScript ошибки

**Файл:** `src/app/page.tsx`, `src/lib/mcp-client.ts`

- Добавлены проверки типов для `message.content`
- Исправлена итерация по Map.entries()
- Добавлены приведения типов для MCP результатов

## Примеры использования

### Поиск информации в интернете
```
Пользователь: "Найди информацию о курсе биткоина"
AI: [Использует search_web] -> [Возвращает результаты поиска]
```

### Получение содержимого страницы
```
Пользователь: "Получи содержимое страницы https://example.com/article"
AI: [Использует fetch_webpage] -> [Возвращает текстовое содержимое]
```

### Комбинирование инструментов
```
Пользователь: "Найди информацию о курсе USD и сравни с официальным курсом ЦБ РФ"
AI: [Использует search_web] -> [Использует cbr_rates] -> [Сравнивает результаты]
```

## Технические детали

### Безопасность
- User-Agent маскировка для обхода блокировок
- Проверка типа контента (только text/html и text/plain)
- Обработка ошибок HTTP и сетевых проблем
- Все ошибки логируются и возвращаются в понятном виде

### Производительность
- Автоматическое сжатие больших страниц
- Удаление scripts и styles из HTML
- Ограничение размера результатов
- Параллельное подключение к MCP серверам

### Ограничения
- DuckDuckGo API может не возвращать результаты для всех запросов
- Некоторые сайты блокируют автоматические запросы
- Сжатие может терять информацию из середины страницы
- Максимальная длина текста ограничена для экономии токенов

## Следующие шаги

Возможные улучшения:
1. Добавить кеширование результатов `fetch_webpage`
2. Поддержка других поисковых систем (Google Custom Search, Bing)
3. Парсинг структурированных данных (JSON-LD, meta tags)
4. Поддержка PDF и других форматов документов
5. Интеллектуальное извлечение основного контента (readability)
6. Rate limiting для предотвращения блокировок

